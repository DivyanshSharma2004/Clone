<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Chat</title>
    <meta charset="UTF-8"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        <!-- ai generated page, i understand the code fully-->
        body, html { height: 100%; }
        #sidebar { height: 100vh; overflow-y: auto; }
        #messages { height: 80vh; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        #chatInput { width: 100%; }
        .friend-item { cursor: pointer; padding: 10px; border-bottom: 1px solid #ddd; }
        .friend-item.active { background-color: #e2e6ea; }
        .message-sent { text-align: right; }
        .message-received { text-align: left; }
        .message-content { display: inline-block; padding: 8px 12px; border-radius: 15px; margin: 2px 0; max-width: 70%; }
        .message-sent .message-content { background-color: #007bff; color: white; }
        .message-received .message-content { background-color: #e2e3e5; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar: Friends -->
        <div id="sidebar" class="col-3 bg-light p-0">
            <h5 class="p-3 border-bottom">Friends</h5>
            <div id="friendList"></div>
        </div>

        <!-- Chat Area -->
        <div class="col-9 d-flex flex-column">
            <h5 class="p-3 border-bottom" id="chatHeader">Select a friend to chat</h5>
            <div id="messages" class="flex-grow-1 mb-2"></div>
            <form id="chatForm" class="d-flex p-3" style="display:none;">
                <input id="chatInput" type="text" placeholder="Type a message..." autocomplete="off" required />
                <button class="btn btn-primary ms-2" type="submit">Send</button>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
        const currentProfileId = /*[[${session.profileId}]]*/ '';
    /*]]>*/
</script>
<script>
    let stompClient = null;
    let currentFriendshipId = null;
    let subscriptions = {};

    // Fetch friends and populate sidebar
    async function loadFriends() {
        const res = await fetch('/message/friendships');
        const friends = await res.json();

        const friendList = document.getElementById('friendList');
        friendList.innerHTML = '';

        friends.forEach(friend => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.dataset.friendshipId = friend.id;
            div.dataset.friendUsername = friend.friendUsername;
            div.dataset.friendId = friend.friendId;

            div.innerHTML = `
                <img src="${friend.friendProfilePictureUrl || 'https://via.placeholder.com/40'}" alt="pic" width="40" height="40" class="rounded-circle me-2" />
                <strong>${friend.friendUsername}</strong>
            `;

            div.addEventListener('click', () => {
                selectFriend(friend.id, friend.friendUsername);
            });

            friendList.appendChild(div);
        });
    }

    // Select friend to chat
    async function selectFriend(friendshipId, friendUsername) {
        if (currentFriendshipId === friendshipId) return; // no change

        currentFriendshipId = friendshipId;

        document.getElementById('chatHeader').textContent = `Chatting with ${friendUsername}`;
        document.getElementById('messages').innerHTML = '';
        document.getElementById('chatForm').style.display = 'flex';

        // Highlight active friend
        document.querySelectorAll('.friend-item').forEach(elem => {
            elem.classList.toggle('active', elem.dataset.friendshipId === friendshipId);
        });

        // Unsubscribe previous subscription
        if (subscriptions[currentFriendshipId]) {
            subscriptions[currentFriendshipId].unsubscribe();
            delete subscriptions[currentFriendshipId];
        }

        // Fetch old messages
        const res = await fetch(`/message/friendship/${friendshipId}`);
        const messages = await res.json();
        messages.forEach(displayMessage);

        // Subscribe to STOMP topic for live messages
        subscriptions[friendshipId] = stompClient.subscribe(`/topic/friendship/${friendshipId}`, (msg) => {
            const message = JSON.parse(msg.body);
            displayMessage(message);
        });
    }

    // Display message in chat
    function displayMessage(message) {
        const container = document.getElementById('messages');

        // Avoid duplicate messages if already present (optional)
        if (document.getElementById(`msg-${message.id}`)) return;

        const div = document.createElement('div');
        div.id = `msg-${message.id}`;

        // Simple styling: messages sent by current user right-aligned
        const isSentByCurrentUser = message.senderId === currentProfileId;
        div.className = isSentByCurrentUser ? 'message-sent' : 'message-received';

        const time = new Date(message.timestamp).toLocaleTimeString();

        div.innerHTML = `
            <div class="message-content">
                ${message.content} <br/><small class="text-muted">${time}</small>
            </div>
        `;

        container.appendChild(div);
        container.scrollTop = container.scrollHeight; // scroll to bottom
    }

    // Send message handler
    function sendMessage(event) {
        event.preventDefault();

        if (!currentFriendshipId) {
            alert('Select a friend first!');
            return;
        }

        const input = document.getElementById('chatInput');
        const content = input.value.trim();
        if (!content) return;

        // Build message object
        const message = {
            friendshipId: currentFriendshipId,
            senderId: currentProfileId,
            content: content
        };

        stompClient.send('/app/sendMessage', {}, JSON.stringify(message));
        input.value = '';
    }

    // Initialize STOMP connection
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log('Connected to WebSocket');
            loadFriends();
        }, (error) => {
            console.error('WebSocket error:', error);
        });
    }

    // DOM ready
    document.addEventListener('DOMContentLoaded', () => {
        connect();

        document.getElementById('chatForm').addEventListener('submit', sendMessage);
    });
</script>
</body>
</html>
